<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新增主題包</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            min-height: 100vh;
        }
        
        /* Simple card */
        .simple-card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* Enhanced shadows */
        .enhanced-shadow {
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Hover animations */
        .hover-lift {
            transition: all 0.2s ease;
        }
        
        .hover-lift:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.1);
        }
        
        /* Loading animation */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        
        /* Simple fade in animation */
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Custom switch styling for the checkbox */
        .switch {
            position: relative;
            display: inline-block;
            width: 48px; /* Slightly wider for better look */
            height: 28px; /* Slightly taller */
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 28px; /* Make it pill-shaped */
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px; /* Slightly smaller for thumb */
            width: 20px; /* Slightly smaller for thumb */
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #3b82f6;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(20px); /* Move thumb to the right */
            -ms-transform: translateX(20px);
            transform: translateX(20px);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React and ReactDOM CDN (Development versions) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX transformation in browser (for simple local testing) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        // Function to determine background color class based on question count (legacy - keeping for compatibility)
        const getBackgroundColorClass = (questionCount) => {
            return 'bg-white/80 text-gray-800'; // Simplified for new design
        };
        
        // Function to get question count badge color
        const getQuestionCountBadgeClass = (count) => {
            if (count === 0) return 'bg-gray-100 text-gray-600';
            if (count <= 5) return 'bg-blue-100 text-blue-700';
            if (count <= 10) return 'bg-green-100 text-green-700';
            if (count <= 20) return 'bg-yellow-100 text-yellow-700';
            if (count <= 30) return 'bg-orange-100 text-orange-700';
            return 'bg-red-100 text-red-700';
        };

        // Helper function to parse a single CSV row with strict validation
        const parseCsvRowStrict = (rowString) => {
            // Handle empty or whitespace-only rows
            if (!rowString || !rowString.trim()) {
                return { isValid: false, errorMessage: '空白行' };
            }
            
            try {
                // Simple CSV parsing that handles quoted fields
                const parts = [];
                let current = '';
                let inQuotes = false;
                let i = 0;
                
                // Safety check for extremely long strings
                if (rowString.length > 10000) {
                    return { isValid: false, errorMessage: '行內容過長（超過 10000 字元）' };
                }
                
                while (i < rowString.length) {
                    const char = rowString[i];
                    
                    if (char === '"' && !inQuotes) {
                        inQuotes = true;
                    } else if (char === '"' && inQuotes) {
                        if (i + 1 < rowString.length && rowString[i + 1] === '"') {
                            current += '"'; // Escaped quote
                            i++; // Skip next quote
                        } else {
                            inQuotes = false;
                        }
                    } else if (char === ',' && !inQuotes) {
                        parts.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                    i++;
                }
                parts.push(current.trim()); // Add the last part
                
                // Safety check for too many parts
                if (parts.length > 50) {
                    return { isValid: false, errorMessage: '欄位數量異常（超過 50 個）' };
                }
                
                // Check for exactly 6 columns
                if (parts.length !== 6) {
                    return { isValid: false, errorMessage: `欄位數量錯誤 (應為 6 個，但找到 ${parts.length} 個)` };
                }

                const [subtitle, content, animations, expressions, questionNumbersStr, orderStr] = parts;

                // Validate animations and expressions must be "[]"
                if (animations !== '[]' || expressions !== '[]') {
                    return { isValid: false, errorMessage: 'animations 或 expressions 欄位格式錯誤 (應為 [])' };
                }

                // Validate questionNumbers is a non-negative integer
                const questionNumbers = parseInt(questionNumbersStr);
                if (isNaN(questionNumbers) || questionNumbers < 0) {
                    return { isValid: false, errorMessage: 'questionNumbers 欄位必須為非負整數' };
                }

                // Validate order is an integer
                const order = parseInt(orderStr);
                if (isNaN(order)) {
                    return { isValid: false, errorMessage: 'order 欄位必須為整數' };
                }

                return {
                    isValid: true,
                    data: {
                        title: subtitle,
                        content: content,
                        questionCount: questionNumbers,
                    }
                };
            } catch (error) {
                return { isValid: false, errorMessage: `解析錯誤: ${error.message}` };
            }
        };

        // Function to parse the entire CSV string into an array of paragraph objects
        const parseCsvString = (csvString, currentNextId) => {
            // Safety checks for input
            if (!csvString || typeof csvString !== 'string') {
                return { parsedParagraphs: [], newNextId: currentNextId, importError: 'CSV 內容為空或格式不正確' };
            }
            
            // Limit file size to prevent memory issues (500KB)
            if (csvString.length > 500000) {
                return { parsedParagraphs: [], newNextId: currentNextId, importError: 'CSV 檔案過大（超過 500KB），請分割後重新匯入' };
            }
            
            try {
                const rows = csvString.trim().split('\n');
                let parsedParagraphs = [];
                let localNextId = currentNextId;
                let importError = null;
                
                // Limit number of rows to prevent memory issues
                if (rows.length > 1000) {
                    return { parsedParagraphs: [], newNextId: currentNextId, importError: 'CSV 行數過多（超過 1000 行），請分割後重新匯入' };
                }

                // Determine if the first row is a header and skip it
                let dataRows = [...rows];
                if (rows.length > 0) {
                    const firstRow = rows[0].toLowerCase();
                    if (firstRow.includes('subtitle') && firstRow.includes('content') && 
                        firstRow.includes('animations') && firstRow.includes('expressions') && 
                        firstRow.includes('questionnumbers') && firstRow.includes('order')) {
                        dataRows = rows.slice(1);
                    }
                }

                for (let i = 0; i < dataRows.length; i++) {
                    const rowString = dataRows[i];
                    if (!rowString.trim()) continue; // Skip empty lines

                    const result = parseCsvRowStrict(rowString);
                    if (result.isValid) {
                        parsedParagraphs.push({
                            id: localNextId++,
                            ...result.data,
                        });
                    } else {
                        if (result.errorMessage !== '空白行') {
                            importError = `CSV 格式錯誤，第 ${i + 1} 行：${result.errorMessage}`;
                            parsedParagraphs = [];
                            break;
                        }
                    }
                }
                return { parsedParagraphs, newNextId: localNextId, importError };
            } catch (error) {
                return { parsedParagraphs: [], newNextId: currentNextId, importError: `解析過程發生錯誤: ${error.message}` };
            }
        };


        // ParagraphItem Component: Renders a single paragraph and manages its editing state
        function ParagraphItem({ paragraph, onUpdate, onDelete, onDragStart, onDragEnter, onDragOver, onDrop, isDraggingOver }) {
            const [isEditing, setIsEditing] = React.useState(paragraph.isEditing || false);
            const [currentTitle, setCurrentTitle] = React.useState(paragraph.title);
            const [currentContent, setCurrentContent] = React.useState(paragraph.content);
            const [currentQuestionCount, setCurrentQuestionCount] = React.useState(parseInt(paragraph.questionCount || 0));
            const [errorMessage, setErrorMessage] = React.useState('');

            // Update internal state if paragraph prop changes (e.g., after save or reorder)
            React.useEffect(() => {
                setCurrentTitle(paragraph.title);
                setCurrentContent(paragraph.content);
                setCurrentQuestionCount(parseInt(paragraph.questionCount || 0)); // Ensure it's a number
                setIsEditing(paragraph.isEditing || false); // Ensure initial editing state is respected
            }, [paragraph]);

            // Handle saving the edited paragraph
            const handleSave = () => {
                if (currentQuestionCount < 0) {
                    setErrorMessage('回答問題數不能為負數。');
                    return;
                }
                onUpdate({
                    ...paragraph,
                    title: currentTitle,
                    content: currentContent,
                    questionCount: parseInt(currentQuestionCount),
                    isEditing: false, // Exit editing mode after saving
                });
                setErrorMessage('');
                setIsEditing(false); // Update local state as well
            };

            // Handle canceling the edit
            const handleCancel = () => {
                if (paragraph.title === '' && paragraph.content === '' && paragraph.questionCount === 0) {
                    // If it's a newly added empty paragraph, delete it on cancel
                    onDelete(paragraph.id);
                } else {
                    // Revert to original values and exit editing mode
                    setCurrentTitle(paragraph.title);
                    setCurrentContent(paragraph.content);
                    setCurrentQuestionCount(parseInt(paragraph.questionCount || 0));
                    setIsEditing(false);
                    setErrorMessage('');
                }
            };

            // Handle incrementing question count
            const incrementQuestionCount = () => {
                setCurrentQuestionCount(prev => prev + 1);
            };

            // Handle decrementing question count, ensuring it doesn't go below 0
            const decrementQuestionCount = () => {
                setCurrentQuestionCount(prev => Math.max(0, prev - 1));
            };

            // Handle manual input for question count
            const handleQuestionCountChange = (e) => {
                const value = parseInt(e.target.value);
                // If input is empty, treat as 0 or keep empty for user to type
                // Here, we'll convert empty string to 0 for consistency with number input
                setCurrentQuestionCount(isNaN(value) ? 0 : Math.max(0, value));
            };

            // Get the background color class based on currentQuestionCount
            const backgroundColorClass = getBackgroundColorClass(paragraph.questionCount);
            const cardBackgroundClass = isEditing 
                ? 'bg-white border-2 border-blue-300' 
                : 'bg-white border border-gray-200 hover-lift';

            return (
                <li
                    key={paragraph.id}
                    draggable={!isEditing}
                    onDragStart={onDragStart}
                    onDragEnter={onDragEnter}
                    onDragOver={onDragOver}
                    onDrop={onDrop}
                    className={`flex flex-col gap-3 rounded-lg p-4 shadow-sm transition-all duration-200 cursor-${isEditing ? 'default' : 'move'} ${
                        cardBackgroundClass
                    } ${
                        isDraggingOver ? 'border-2 border-dashed border-blue-400 bg-blue-50' : ''
                    }`}
                >
                    {isEditing ? (
                        // Editing Mode - Vertical layout for inputs
                        <div className="flex w-full flex-col space-y-3">
                            {/* Order Badge */}
                            <div className="flex items-center justify-between mb-3">
                                <div className="flex items-center gap-3">
                                    <div className="bg-blue-500 text-white px-3 py-1 rounded-full text-sm font-semibold">
                                        #{paragraph.order}
                                    </div>
                                    <div className="text-sm font-medium text-gray-600">編輯中...</div>
                                </div>
                                <i className="material-icons text-gray-400">drag_indicator</i>
                            </div>

                            {/* Title */}
                            <div className="space-y-2">
                                <label htmlFor={`title-input-${paragraph.id}`} className="flex items-center text-sm font-semibold text-gray-700">
                                    <i className="material-icons mr-2 text-lg">title</i>
                                    標題
                                </label>
                                <input
                                    type="text"
                                    id={`title-input-${paragraph.id}`}
                                    value={currentTitle}
                                    onChange={(e) => setCurrentTitle(e.target.value)}
                                    className="w-full rounded-lg border border-gray-300 bg-white p-3 text-gray-800 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-200"
                                    placeholder="輸入段落標題"
                                />
                            </div>

                            {/* Content */}
                            <div className="space-y-2">
                                <label htmlFor={`content-textarea-${paragraph.id}`} className="flex items-center text-sm font-semibold text-gray-700">
                                    <i className="material-icons mr-2 text-lg">subject</i>
                                    內容
                                </label>
                                <textarea
                                    id={`content-textarea-${paragraph.id}`}
                                    value={currentContent}
                                    onChange={(e) => setCurrentContent(e.target.value)}
                                    rows="4"
                                    className="w-full rounded-lg border border-gray-300 bg-white p-3 text-gray-800 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-200 resize-none"
                                    placeholder="輸入段落內容"
                                ></textarea>
                            </div>

                            {/* Question Count */}
                            <div className="space-y-2">
                                <label htmlFor={`question-count-input-${paragraph.id}`} className="flex items-center text-sm font-semibold text-gray-700">
                                    <i className="material-icons mr-2 text-lg">quiz</i>
                                    回答問題數
                                </label>
                                <div className="flex items-center gap-3">
                                    <button
                                        type="button"
                                        onClick={decrementQuestionCount}
                                        className="rounded-lg bg-red-500 p-2 text-white transition-all duration-200 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300"
                                        title="減少問題數"
                                    >
                                        <i className="material-icons text-sm">remove</i>
                                    </button>
                                    <input
                                        type="number"
                                        id={`question-count-input-${paragraph.id}`}
                                        value={currentQuestionCount}
                                        onChange={handleQuestionCountChange}
                                        className="w-20 text-center rounded-lg border border-gray-300 bg-white p-2 text-gray-800 font-semibold focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-200"
                                        min="0"
                                    />
                                    <button
                                        type="button"
                                        onClick={incrementQuestionCount}
                                        className="rounded-lg bg-green-500 p-2 text-white transition-all duration-200 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300"
                                        title="增加問題數"
                                    >
                                        <i className="material-icons text-sm">add</i>
                                    </button>
                                </div>
                            </div>

                            {errorMessage && (
                                <div className="bg-red-50 border border-red-200 rounded-lg p-3 flex items-center">
                                    <i className="material-icons text-red-500 mr-2">error</i>
                                    <p className="text-sm font-medium text-red-700">{errorMessage}</p>
                                </div>
                            )}
                            
                            <div className="flex justify-end gap-3 pt-4 border-t border-gray-200">
                                <button
                                    onClick={handleCancel}
                                    className="flex items-center rounded-lg border border-gray-300 bg-white px-4 py-2 font-medium text-gray-700 shadow-sm transition-all duration-200 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-200"
                                >
                                    <i className="material-icons mr-2 text-sm">close</i>
                                    取消
                                </button>
                                <button
                                    onClick={handleSave}
                                    className="flex items-center rounded-lg bg-blue-500 px-4 py-2 font-medium text-white shadow-sm transition-all duration-200 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300"
                                >
                                    <i className="material-icons mr-2 text-sm">save</i>
                                    儲存
                                </button>
                            </div>
                        </div>
                    ) : (
                        // Display Mode - Enhanced card layout
                        <>
                            <div className="flex items-center justify-between mb-3">
                                <div className="flex items-center gap-3">
                                    <div className="bg-blue-500 text-white px-3 py-1 rounded-full text-sm font-semibold">
                                        #{paragraph.order}
                                    </div>
                                    <i className="material-icons text-gray-500 cursor-move" title="拖曳重新排序">drag_indicator</i>
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => setIsEditing(true)}
                                        className="rounded-lg bg-orange-500 p-2 text-white transition-all duration-200 hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-300"
                                        title="編輯"
                                    >
                                        <i className="material-icons text-sm">edit</i>
                                    </button>
                                    <button
                                        onClick={() => onDelete(paragraph.id)}
                                        className="rounded-lg bg-red-500 p-2 text-white transition-all duration-200 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300"
                                        title="刪除"
                                    >
                                        <i className="material-icons text-sm">delete</i>
                                    </button>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                <div className="bg-blue-50 rounded-lg p-3 border-l-4 border-blue-500">
                                    <div className="flex items-center mb-1">
                                        <i className="material-icons text-blue-600 mr-2 text-base">title</i>
                                        <span className="text-sm font-medium text-blue-800">標題</span>
                                    </div>
                                    <p className="text-gray-800 truncate" title={paragraph.title}>
                                        {paragraph.title || '無標題'}
                                    </p>
                                </div>
                                
                                <div className="bg-green-50 rounded-lg p-3 border-l-4 border-green-500">
                                    <div className="flex items-center mb-1">
                                        <i className="material-icons text-green-600 mr-2 text-base">subject</i>
                                        <span className="text-sm font-medium text-green-800">內容</span>
                                    </div>
                                    <p className="text-gray-800 truncate" title={paragraph.content}>
                                        {paragraph.content || '無內容'}
                                    </p>
                                </div>
                                
                                <div className={`rounded-lg p-3 border-l-4 ${
                                    paragraph.questionCount > 0 
                                        ? 'bg-orange-50 border-orange-400' 
                                        : 'bg-purple-50 border-purple-500'
                                }`}>
                                    <div className="flex items-center mb-1">
                                        <i className={`material-icons mr-2 text-base ${
                                            paragraph.questionCount > 0 ? 'text-orange-600' : 'text-purple-600'
                                        }`}>quiz</i>
                                        <span className={`text-sm font-medium ${
                                            paragraph.questionCount > 0 ? 'text-orange-800' : 'text-purple-800'
                                        }`}>問題數</span>
                                    </div>
                                    <div className="flex items-center">
                                        <span className={`text-xl font-semibold mr-1 ${
                                            paragraph.questionCount > 0 ? 'text-orange-700' : 'text-gray-800'
                                        }`}>{paragraph.questionCount}</span>
                                        <span className="text-sm text-gray-600">個問題</span>
                                    </div>
                                </div>
                            </div>
                        </>
                    )}
                </li>
            );
        }

        // Main App Component
        function App() {
            const [paragraphs, setParagraphs] = React.useState([]);
            const [fileName, setFileName] = React.useState('theme_pack'); // State for file name
            const [csvInputText, setCsvInputText] = React.useState(''); // State for CSV input text
            const [importMessage, setImportMessage] = React.useState(null); // State for import feedback message
            const [showImportSection, setShowImportSection] = React.useState(false); // New state for toggling import section

            const nextIdRef = React.useRef(0); // To generate unique IDs for paragraphs
            const dragItem = React.useRef(null); // Reference to the dragged item
            const dragOverItem = React.useRef(null); // Reference to the item being dragged over
            const textareaRef = React.useRef(null); // Ref for the CSV import textarea
            const [isLoading, setIsLoading] = React.useState(false); // Loading state for operations
            const [notification, setNotification] = React.useState(null); // Notification state
            const [showOnlyWithQuestions, setShowOnlyWithQuestions] = React.useState(false); // Filter for paragraphs with questions

            // Effect to initialize nextIdRef from existing paragraphs on load, or start from 0
            React.useEffect(() => {
                if (paragraphs.length > 0) {
                    nextIdRef.current = Math.max(...paragraphs.map(p => p.id)) + 1;
                } else {
                    nextIdRef.current = 0;
                }
            }, [paragraphs]);
            
            // Keyboard shortcuts
            React.useEffect(() => {
                const handleKeyPress = (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key) {
                            case 'n':
                                e.preventDefault();
                                handleAddParagraph();
                                showNotification('已新增段落', 'success');
                                break;
                            case 's':
                                e.preventDefault();
                                handleExportCSV();
                                showNotification('CSV 檔案已匯出', 'success');
                                break;
                            case 'i':
                                e.preventDefault();
                                setShowImportSection(!showImportSection);
                                break;
                        }
                    }
                    if (e.key === 'Escape') {
                        // Close any editing paragraphs
                        setParagraphs(prev => prev.map(p => ({ ...p, isEditing: false })));
                    }
                };
                
                document.addEventListener('keydown', handleKeyPress);
                return () => document.removeEventListener('keydown', handleKeyPress);
            }, [showImportSection]);
            
            // Auto-hide notification
            React.useEffect(() => {
                if (notification) {
                    const timer = setTimeout(() => {
                        setNotification(null);
                    }, 3000);
                    return () => clearTimeout(timer);
                }
            }, [notification]);
            
            // Show notification helper
            const showNotification = (message, type = 'info') => {
                setNotification({ message, type });
            };
            
            // Download sample CSV file
            const handleDownloadSample = () => {
                const sampleData = [
                    ['subtitle', 'content', 'animations', 'expressions', 'questionNumbers', 'order'],
                    ['範例標題一', '這是第一個段落的內容，用來示範CSV格式。', '[]', '[]', '5', '1'],
                    ['範例標題二', '這是第二個段落的內容，可以包含較長的文字描述。', '[]', '[]', '3', '2'],
                    ['範例標題三', '第三個段落展示如何處理特殊字元，例如：引號"和逗號,。', '[]', '[]', '0', '3']
                ];
                
                const csvContent = sampleData.map(row => 
                    row.map(cell => `"${cell.toString().replace(/"/g, '""')}"`).join(',')
                ).join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    link.setAttribute('href', URL.createObjectURL(blob));
                    link.setAttribute('download', 'article_pack_content_sample.csv');
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showNotification('範例檔案已下載', 'success');
                }
            };

            // Setup drag-and-drop listeners for the textarea
            React.useEffect(() => {
                const textarea = textareaRef.current;
                if (!textarea || !showImportSection) return; // Only attach if section is visible

                const handleDragOver = (e) => {
                    e.preventDefault(); // Essential to allow drop
                    e.stopPropagation();
                    textarea.classList.add('border-blue-500', 'ring-2', 'ring-blue-500'); // Visual feedback
                };

                const handleDragLeave = (e) => {
                    e.stopPropagation();
                    textarea.classList.remove('border-blue-500', 'ring-2', 'ring-blue-500'); // Remove visual feedback
                };

                const handleDrop = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    textarea.classList.remove('border-blue-500', 'ring-2', 'ring-blue-500'); // Remove visual feedback

                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        if (file.type === 'text/csv' || file.name.toLowerCase().endsWith('.csv')) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                setCsvInputText(event.target.result);
                                setImportMessage({ type: 'info', text: '檔案已載入。請點擊「匯入段落內容」按鈕進行匯入。' });
                            };
                            reader.onerror = () => {
                                setImportMessage({ type: 'error', text: '讀取檔案時發生錯誤。' });
                            };
                            reader.readAsText(file);
                        } else {
                            setImportMessage({ type: 'error', text: '請拖曳有效的 .csv 檔案。' });
                        }
                    }
                };

                textarea.addEventListener('dragover', handleDragOver);
                textarea.addEventListener('dragleave', handleDragLeave);
                textarea.addEventListener('drop', handleDrop);

                return () => {
                    textarea.removeEventListener('dragover', handleDragOver);
                    textarea.removeEventListener('dragleave', handleDragLeave);
                    textarea.removeEventListener('drop', handleDrop);
                };
            }, [showImportSection]); // Re-attach listeners if section visibility changes

            // Handler to add a new, empty paragraph directly to the list in editing mode
            const handleAddParagraph = () => {
                const newParagraph = {
                    id: nextIdRef.current++,
                    title: '',
                    content: '',
                    questionCount: 0,
                    order: paragraphs.length + 1, // Assign order based on current list length
                    isEditing: true, // New paragraph starts in editing mode
                };
                setParagraphs([...paragraphs, newParagraph]);
                setImportMessage(null); // Clear import message on adding new paragraph
                showNotification('已新增段落', 'success');
            };

            // Handler to update an existing paragraph (called from ParagraphItem)
            const handleUpdateParagraph = (updatedParagraph) => {
                setParagraphs(paragraphs.map(p =>
                    p.id === updatedParagraph.id ? updatedParagraph : p
                ));
            };

            // Handler to delete a paragraph
            const handleDeleteParagraph = (id) => {
                if (confirm('確定要刪除這個段落嗎？')) {
                    const updatedParagraphs = paragraphs.filter(p => p.id !== id);
                    // Reassign order after deletion
                    setParagraphs(updatedParagraphs.map((p, index) => ({ ...p, order: index + 1 })));
                    showNotification('段落已刪除', 'success');
                }
            };

            // Drag and Drop Handlers for reordering paragraphs in the list
            const handleDragStart = (e, index) => {
                dragItem.current = index;
                e.dataTransfer.effectAllowed = "move";
                e.dataTransfer.setData("text/plain", index);
            };

            const handleDragEnter = (e, index) => {
                e.preventDefault();
                dragOverItem.current = index;
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = "move";
            };

            const handleDrop = React.useCallback(() => {
                const dragIndex = dragItem.current;
                const dropIndex = dragOverItem.current;

                if (dragIndex === null || dropIndex === null || dragIndex === dropIndex) {
                    dragItem.current = null;
                    dragOverItem.current = null;
                    return;
                }

                const newParagraphs = [...paragraphs];
                const [reorderedItem] = newParagraphs.splice(dragIndex, 1);
                newParagraphs.splice(dropIndex, 0, reorderedItem);

                // Reassign order after reordering
                setParagraphs(newParagraphs.map((p, index) => ({ ...p, order: index + 1 })));

                dragItem.current = null;
                dragOverItem.current = null;
            }, [paragraphs]);

            // Clear all paragraphs handler
            const handleClearAll = () => {
                if (paragraphs.length === 0) return;
                
                if (confirm('確定要清空所有段落嗎？此操作不可逆轉。')) {
                    setParagraphs([]);
                    showNotification('已清空所有段落', 'success');
                }
            };
            
            // CSV Export Handler
            const handleExportCSV = () => {
                if (paragraphs.length === 0) {
                    showNotification('沒有段落可匯出', 'error');
                    return;
                }
                
                setIsLoading(true);
                // Sort paragraphs by their current order before exporting
                const sortedParagraphs = [...paragraphs].sort((a, b) => a.order - b.order);

                const headers = ["subtitle", "content", "animations", "expressions", "questionNumbers", "order"];
                const csvRows = [];

                // Add headers row
                csvRows.push(headers.join(","));

                // Add data rows
                sortedParagraphs.forEach(p => {
                    // Escape double quotes by replacing them with two double quotes, then enclose in quotes
                    const escapedTitle = `"${p.title.replace(/"/g, '""')}"`;
                    const escapedContent = `"${p.content.replace(/"/g, '""')}"`;

                    const row = [
                        escapedTitle,
                        escapedContent,
                        `"[]"`, // Fixed value for animations
                        `"[]"`, // Fixed value for expressions
                        p.questionCount,
                        p.order,
                    ];
                    csvRows.push(row.join(","));
                });

                const csvString = csvRows.join("\n");
                const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
                const link = document.createElement("a");
                if (link.download !== undefined) {
                    const exportFileName = fileName.trim() === '' ? 'theme_pack' : fileName.trim();
                    link.setAttribute("href", URL.createObjectURL(blob));
                    link.setAttribute("download", `${exportFileName}.csv`);
                    link.style.visibility = "hidden";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showNotification(`CSV 檔案 "${exportFileName}.csv" 已匯出`, 'success');
                }
                setIsLoading(false);
            };

            // Handler for importing CSV content from textarea
            const handleImportCsv = () => {
                setImportMessage(null); // Clear previous messages
                if (!csvInputText.trim()) {
                    setImportMessage({ type: 'error', text: 'CSV 內容不能為空。' });
                    return;
                }

                const { parsedParagraphs: importedItems, newNextId, importError } = parseCsvString(csvInputText, nextIdRef.current);

                if (importError) {
                    setImportMessage({ type: 'error', text: importError });
                    return;
                }

                if (importedItems.length === 0) {
                    setImportMessage({ type: 'error', text: '無法解析 CSV 內容，請檢查格式是否正確。' });
                    return;
                }

                nextIdRef.current = newNextId; // Update the global nextIdRef

                const combinedParagraphs = [...paragraphs, ...importedItems];
                // Reassign order for all paragraphs after combining and sorting
                const reorderedAndNumbered = combinedParagraphs.map((p, index) => ({ ...p, order: index + 1 }));

                setParagraphs(reorderedAndNumbered);
                setCsvInputText(''); // Clear input after import
                setImportMessage({ type: 'success', text: 'CSV 內容已成功匯入！' });
                showNotification(`已匯入 ${importedItems.length} 個段落`, 'success');
            };


            return (
                <div className="min-h-screen bg-gray-50 p-4 font-inter text-gray-800 antialiased">
                    <div className="container mx-auto simple-card p-8 relative max-w-6xl">
                        <div className="text-center mb-8">
                            <h1 className="text-4xl font-bold text-gray-900 mb-3">
                                新增主題包
                            </h1>
                            <p className="text-gray-600 text-lg">創建和管理您的文章段落內容</p>
                        </div>

                        {/* Action buttons at top right */}
                        <div className="absolute top-8 right-8 flex gap-3">
                            <button
                                onClick={handleClearAll}
                                disabled={paragraphs.length === 0}
                                className="flex items-center rounded-lg bg-red-500 px-4 py-2.5 font-semibold text-white shadow-md transition-all duration-200 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                title="清空所有段落"
                            >
                                <i className="material-icons mr-2 text-sm">clear_all</i>
                                清空
                            </button>
                            <button
                                onClick={handleExportCSV}
                                disabled={isLoading || paragraphs.length === 0}
                                className="flex items-center rounded-lg bg-blue-500 px-4 py-2.5 font-semibold text-white shadow-md transition-all duration-200 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                title="匯出CSV (Ctrl+S)"
                            >
                                {isLoading ? (
                                    <div className="loading-spinner mr-2"></div>
                                ) : (
                                    <i className="material-icons mr-2 text-sm">download</i>
                                )}
                                匯出CSV
                            </button>
                        </div>

                        {/* File Name Input */}
                        <div className="mb-6 bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <label htmlFor="fileName" className="mb-2 block text-sm font-medium text-gray-700 flex items-center">
                                <i className="material-icons mr-2 text-base">drive_file_rename_outline</i>
                                檔案名稱
                            </label>
                            <input
                                type="text"
                                id="fileName"
                                value={fileName}
                                onChange={(e) => setFileName(e.target.value)}
                                className="w-full rounded-lg border border-gray-300 bg-white p-3 text-gray-800 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-200"
                                placeholder="輸入檔案名稱 (例如: theme_pack)"
                            />
                        </div>

                        {/* Toggle for CSV Input Section */}
                        <div className="mb-6 bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <div className="flex items-center justify-between">
                                <label htmlFor="toggleImportSection" className="text-sm font-medium text-gray-700 cursor-pointer flex items-center">
                                    <i className="material-icons mr-2 text-base">upload_file</i>
                                    匯入段落內容
                                </label>
                                <label className="switch">
                                    <input
                                        type="checkbox"
                                        id="toggleImportSection"
                                        checked={showImportSection}
                                        onChange={(e) => setShowImportSection(e.target.checked)}
                                    />
                                    <span className="slider round"></span>
                                </label>
                            </div>

                            {/* CSV Input Section - Conditionally rendered */}
                            {showImportSection && (
                                <div className="mt-4 border-t border-gray-200 pt-4">
                                    <div className="flex items-center justify-between mb-3">
                                        <label htmlFor="csvInput" className="text-sm font-medium text-gray-700 flex items-center">
                                            <i className="material-icons mr-2 text-base">text_snippet</i>
                                            請將 CSV 文本貼上或拖曳至此處
                                        </label>
                                        <button
                                            onClick={handleDownloadSample}
                                            className="flex items-center rounded-lg bg-indigo-500 px-3 py-1.5 text-sm font-medium text-white shadow-sm transition-all duration-200 hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-300"
                                        >
                                            <i className="material-icons mr-1 text-sm">download</i>
                                            下載範例檔案
                                        </button>
                                    </div>
                                    <textarea
                                        ref={textareaRef}
                                        id="csvInput"
                                        value={csvInputText}
                                        onChange={(e) => setCsvInputText(e.target.value)}
                                        rows="6"
                                        className="w-full rounded-lg border-2 border-dashed border-gray-300 bg-white p-4 text-gray-800 focus:border-blue-400 focus:ring-2 focus:ring-blue-200 transition-all duration-200"
                                        placeholder="請貼上或拖曳 CSV 內容，例如:\n標題一,內容一,[],[],10,1\n標題二,內容二,[],[],5,2"
                                    ></textarea>
                                    <div className="mt-3 flex gap-3 flex-wrap">
                                        <button
                                            onClick={handleImportCsv}
                                            disabled={!csvInputText.trim()}
                                            className="flex items-center rounded-lg bg-green-500 px-4 py-2 font-semibold text-white shadow-md transition-all duration-200 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-green-500"
                                        >
                                            <i className="material-icons mr-2 text-sm">upload</i>
                                            匯入段落內容
                                        </button>
                                        <button
                                            onClick={() => setCsvInputText('')}
                                            disabled={!csvInputText.trim()}
                                            className="flex items-center rounded-lg bg-gray-500 px-4 py-2 font-semibold text-white shadow-md transition-all duration-200 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-gray-500"
                                        >
                                            <i className="material-icons mr-2 text-sm">clear</i>
                                            清空
                                        </button>
                                        <div className="text-xs text-gray-500 flex items-center">
                                            <i className="material-icons mr-1 text-sm">info</i>
                                            檔案大小限制：500KB，行數限制：1000行
                                        </div>
                                    </div>
                                    {importMessage && (
                                        <div className={`mt-3 p-3 rounded-lg flex items-center ${
                                            importMessage.type === 'success' 
                                                ? 'bg-green-50 border border-green-200 text-green-700' 
                                                : 'bg-red-50 border border-red-200 text-red-700'
                                        }`}>
                                            <i className="material-icons mr-3 text-base">
                                                {importMessage.type === 'success' ? 'check_circle' : 'error'}
                                            </i>
                                            <p className="text-sm font-medium">{importMessage.text}</p>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* Paragraph List */}
                        <div className="bg-white rounded-lg p-6 border border-gray-200 shadow-sm mb-8">
                            <div className="flex items-center justify-between mb-4">
                                <h2 className="text-xl font-semibold text-gray-900 flex items-center">
                                    <i className="material-icons mr-2 text-2xl">list</i>
                                    段落列表
                                </h2>
                                <div className="flex items-center gap-3 text-sm font-medium">
                                    <div className="text-gray-600">
                                        共 {paragraphs.length} 個段落
                                    </div>
                                    <button
                                        onClick={() => setShowOnlyWithQuestions(!showOnlyWithQuestions)}
                                        className={`flex items-center px-3 py-1 rounded-full transition-all duration-200 ${
                                            showOnlyWithQuestions 
                                                ? 'bg-orange-500 text-white shadow-md' 
                                                : 'bg-orange-100 text-orange-800 hover:bg-orange-200'
                                        }`}
                                        title={showOnlyWithQuestions ? '顯示所有段落' : '只顯示有問題的段落'}
                                    >
                                        <i className="material-icons mr-1 text-sm">{
                                            showOnlyWithQuestions ? 'visibility_off' : 'quiz'
                                        }</i>
                                        {showOnlyWithQuestions ? '顯示全部' : `${paragraphs.filter(p => p.questionCount > 0).length} 個有問題`}
                                    </button>
                                </div>
                            </div>
                            
                            {paragraphs.length === 0 ? (
                                <div className="py-12 text-center">
                                    <i className="material-icons text-5xl text-gray-400 mb-3">article</i>
                                    <p className="text-lg text-gray-600 mb-2">目前沒有段落</p>
                                    <p className="text-gray-500">請點擊下方「新增段落」按鈕來開始創建</p>
                                </div>
                            ) : (
                                <ul className="space-y-4">
                                    {[...paragraphs]
                                        .sort((a, b) => a.order - b.order)
                                        .filter(paragraph => !showOnlyWithQuestions || paragraph.questionCount > 0)
                                        .map((paragraph, index) => (
                                        <div key={paragraph.id} className="fade-in">
                                            <ParagraphItem
                                                paragraph={paragraph}
                                                onUpdate={handleUpdateParagraph}
                                                onDelete={handleDeleteParagraph}
                                                onDragStart={(e) => handleDragStart(e, index)}
                                                onDragEnter={(e) => handleDragEnter(e, index)}
                                                onDragOver={handleDragOver}
                                                onDrop={handleDrop}
                                                isDraggingOver={dragOverItem.current === index}
                                            />
                                        </div>
                                    ))}
                                    {showOnlyWithQuestions && paragraphs.filter(p => p.questionCount > 0).length === 0 && (
                                        <div className="py-8 text-center text-gray-500">
                                            <i className="material-icons text-4xl mb-2">quiz</i>
                                            <p>沒有設定問題數的段落</p>
                                        </div>
                                    )}
                                </ul>
                            )}
                        </div>

                        {/* Add Paragraph Button */}
                        <div className="flex flex-col items-center gap-6">
                            <button
                                onClick={handleAddParagraph}
                                className="flex items-center rounded-lg bg-blue-500 px-6 py-3 font-semibold text-white shadow-md transition-all duration-200 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300"
                                title="新增段落 (Ctrl+N)"
                            >
                                <i className="material-icons mr-2 text-xl">add</i>
                                <span>新增段落</span>
                            </button>
                            
                            {/* Keyboard shortcuts info */}
                            <div className="text-center text-gray-600 text-sm">
                                <p className="mb-3 font-medium">快捷鍵:</p>
                                <div className="space-y-2">
                                    <p><span className="bg-gray-100 px-2 py-1 rounded font-mono text-gray-800">Ctrl+N</span> 新增段落</p>
                                    <p><span className="bg-gray-100 px-2 py-1 rounded font-mono text-gray-800">Ctrl+S</span> 匯出CSV</p>
                                    <p><span className="bg-gray-100 px-2 py-1 rounded font-mono text-gray-800">Ctrl+I</span> 切換匯入</p>
                                </div>
                            </div>
                        </div>
                        
                        {/* Notification */}
                        {notification && (
                            <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 z-50 flex items-center px-4 py-3 rounded-lg shadow-lg transition-all duration-300 ease-in-out ${
                                notification.type === 'success' 
                                    ? 'bg-green-500 text-white' 
                                    : notification.type === 'error'
                                    ? 'bg-red-500 text-white'
                                    : 'bg-blue-500 text-white'
                            }`}>
                                <i className="material-icons mr-2">
                                    {notification.type === 'success' ? 'check_circle' : 
                                     notification.type === 'error' ? 'error' : 'info'}
                                </i>
                                <span className="font-medium">{notification.message}</span>
                                <button 
                                    onClick={() => setNotification(null)}
                                    className="ml-3 hover:bg-white/20 rounded-full p-1 transition-colors"
                                >
                                    <i className="material-icons text-sm">close</i>
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Render the App component into the 'root' div
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>